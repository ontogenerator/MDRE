---
title: "Multi-dimensional reward evaluation in mice"
header-includes:
   - \usepackage{lineno}
   - \linenumbers
output:   
  bookdown::pdf_document2:
    number_sections: no
    toc: no
bibliography: MDRE.bib
---
Vladislav Nachev^1,\*,&#8224;,\S^, Marion Rivalan^1,&#8224;,\S^, York Winter^1,\S^

^1^ Humboldt University, Berlin, Germany

**^\*^For correspondence:** vladislav.nachev\@charite.de  
^&#8224;^These authors contributed equally to this work

**Present Address:** ^\S^Dept. of Biology, Humboldt University, Philippstr. 13, 10099 Berlin, Germany

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Abstract

Please provide an abstract of no more than 150 words. Your abstract should explain the main contributions of your article, and should not contain any material that is not included in the main text. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat.

# Introduction

Your introduction goes here! Some examples of commonly used commands and features are listed below, to help you get started.

Here is a citation: [@kacelnik_risky_1998]
An inline citation has no [] around it, like this: @rivalan_principles_2017.

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Results

```{r, include = FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(lubridate)
library(lme4)
library(coin)
# library(BayesFactor)
# library(citr)

miceChoices <- read.csv2(file = "data/ChoicesOutput.csv", header = TRUE, dec = ".", sep = ";",
                            na.strings = "NA") %>%
  mutate(vol = if_else(cohort == 2, vol * 4.8, vol))

miceChoices <- miceChoices %>%
  group_by(IdLabel, day) %>%
  filter(hour(DateTime) < 9 | hour(DateTime) > 15) %>% # due to older program version the initial visits
  # before the starting could not be flagged and therefore could not be removed by CSVreader.R
  # therefore they need to be removed here
  mutate(count = 1:n(), revcount = n():1) %>%
  group_by(rel,IdLabel,day) %>%
  mutate(relcount = 1:n()) %>%
  ungroup()

summaries <- miceChoices %>%
  group_by(cond, IdLabel, experiment, cohort, rint) %>%
  # take all visits after the first 150 visits at the relevant dispensers:
  filter(relcount > 150) %>%
  # in the following lines is an alternative cut-off point, which leads to very similar results
  # take the last 100 visits at any of the dispensers:
  # filter(revcount < 101) %>%
  summarise(performance = mean(prof, na.rm = TRUE), sampling = 1 - mean(rel),
            Ntot = n(), Nrel = sum(rel),successes_perf = sum(prof, na.rm = T),
            successes_sampl =  Ntot - Nrel) %>%
  ungroup() %>%
  mutate(cohort = factor(cohort))

exp3_tab <- miceChoices %>%
  filter(experiment == 3, !str_detect(cond,"[r]")) %>%
  group_by(cohort, cond) %>%
  summarise(vol = max(volm), prob = max(prob)) %>%
  ungroup() %>%
  mutate(volm = vol/max(vol),
         probm = prob/max(prob),
         dim = str_sub(cond, 1, 1),
         bg_level = ifelse(dim == "P", volm, probm),
         cohort = as.factor(cohort)) %>%
  droplevels()

exp1 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 1)
exp2 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 2)
exp3 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 3) %>%
  inner_join(exp3_tab) %>%
  droplevels()
exp4 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 4)

sesoi <- 0.1 # smallest effect size of interest
```

Here is where the results are described. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.  
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.  

## Some tables and figures
(ref:labresoverview) **Overview of discrimination performance of all mice in all experiments.** More text perhaps.

```{r resoverview, fig.cap="(ref:labresoverview)"}
# cbbPalette <- c("#000000", "#2C96BF", "#D4D93D", "#148C76", "#35F265", "#048C8C", "#D55E00", "#F0E442")

ggexp12_4 <- summaries %>%
  filter(!str_detect(cond, "[r]"), experiment != 3) %>%
  ggplot(aes(cond, performance, color = cohort, group = IdLabel)) + geom_point() + geom_line() +
  facet_grid(experiment ~ .) + xlab("condition") + ylab("discrimination performance") +
  theme_bw() + scale_color_viridis_d() + guides(color = FALSE) +
  theme(strip.text.y = element_text(angle = 0))

ggexp3 <- exp3 %>%
  ggplot(aes(cond, performance, color = cohort, group = IdLabel)) + geom_point() + geom_line() +
  facet_grid(experiment ~ .) + xlab("condition") +
  scale_y_continuous(name = "", breaks = seq(0, 1, 0.25)) +
  theme_bw() + scale_color_viridis_d() + theme(legend.position = "bottom") +
  theme(strip.text.y = element_text(angle = 0))

get_legend <- function(a.gplot){ 
  tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
  leg <- which(map(tmp$grobs, "name") == "guide-box") 
  legend <- tmp$grobs[[leg]] 
  return(legend)} 

leg <- get_legend(ggexp3)

lay <- rbind(c(1, 3),
             c(1, 2),
             c(1, NA))

grid.arrange(ggexp12_4, ggexp3 + guides(color = FALSE), leg, layout_matrix = lay,
             heights = c(1, 1.3, 1))
```

You can also embed plots, for example in Fig. \@ref(fig:resoverview).  

(ref:labresexp1) **Some text about the results from Experiment 1**. More text after that

```{r exp1, fig.cap="(ref:labresexp1)"}
exp1_simpl <- exp1 %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp1_diff <- exp1_simpl %>%
  spread(cond, performance) %>%
  mutate("BP-BV" = BP - BV, "BP-C" = BP - C, "BV-C" = BV - C,
         "BP-I" = BP - 1 + I, "BV-I" = BV - I) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

n_compare <- exp1_diff %>%
  ungroup() %>%
  filter(cond != "BP-BV") %>%
  select(cond) %>%
  unique() %>%
  nrow()

alpha_1 <- 0.05
alpha_2 <- 0.05 / (n_compare - 1) # alpha corrected for multiple comparisons

set.seed(42)
exp1_diff %>%
  filter(cond != "BP-BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_2)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()
```


(ref:labresexp2) **Some text about the results from Experiment 2**. More text after that

```{r exp2, fig.cap="(ref:labresexp2)"}
exp2_simpl <- exp2 %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp2_diff <- exp2_simpl %>%
  spread(cond, performance) %>%
  mutate("BP-BV" = BP - BV, "BP-C" = BP - C, "BV-C" = BV - C,
         "BP-I" = BP - 1 + I, "BV-I" = BV - I) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

set.seed(42)
exp2_diff %>%
  filter(cond != "BP-BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()

```


(ref:labresexp3) **Some text about the results from Experiment 3**. The relative intensities for the two dimensions were the same in cohorts 1,3 (rint = 0.86), but different in cohort 2 (rintp = 0.86, rintv = 0.67)

```{r exp3, fig.cap="(ref:labresexp3)"}

slopes <- exp3 %>%
  split(.$dim) %>%
  map(~ lmer(performance ~ bg_level + (bg_level|IdLabel), data = .)) %>%
  map(coef) %>%
  map("IdLabel") %>%
  map_df(~rownames_to_column(., var = "IdLabel"))

dims <- data.frame(dimension = rep(c("prob", "vol"), each = 24))

cohorts <- exp3 %>%
  ungroup() %>%
  select(IdLabel, cohort) %>%
  distinct()

slopes <- slopes %>%
  bind_cols(dims) %>%
  rename(slope = bg_level) %>%
  inner_join(cohorts)

sl_sesoi <- data.frame(val = c(4/20, 20/20),
                       performance = c(0.8, 0.9))

sl_sesoi <- coef(lm(performance ~ val, data = sl_sesoi))[2]

set.seed(42)
slopes %>%
  ggplot(aes(dimension, slope)) +
  stat_summary(fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  geom_hline(yintercept = sl_sesoi, linetype = 2) + geom_hline(yintercept = -sl_sesoi, linetype = 2) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  scale_color_viridis_d()

```


(ref:labsimexp1) **Comparison of the discrimination performances in all seven simulation models and in the three mouse cohorts in Experiment 1**. More text to explain the figure  

```{r simexp1, fig.height = 7, fig.cap="(ref:labsimexp1)"}

summ_Exp1 <- read.csv2(file = "data/summ_Exp1.csv", header = TRUE, dec = ".", sep = ";",
                       na.strings = "NA") %>%
  rename(cond = cond_names) %>%
  group_by(cond, Choice_type) %>%
  mutate(medperf = median(performance))

summ_Exp2 <- read.csv2(file = "data/summ_Exp2.csv", header = TRUE, dec = ".", sep = ";",
                       na.strings = "NA") %>%
  rename(cond = cond_names) %>%
  group_by(cond, Choice_type) %>%
  mutate(medperf = median(performance))

summ_Exp3 <- read.csv2(file = "data/summ_Exp3.csv", header = TRUE, dec = ".", sep = ";",
                       na.strings = "NA") %>%
  rename(cond = cond_names) %>%
  group_by(cond, Choice_type) %>%
  mutate(medperf = median(performance))

exp1 <- exp1 %>%
  group_by(cond) %>%
  mutate(medperf = median(performance))

ggplot() +
  geom_density(aes(performance), size = 1.2, data = summ_Exp1) +
  # stat_summary(aes(cond_names, performance, group = Choice_type), fun.data = "mean_cl_boot") +
  facet_grid(Choice_type ~ cond) +
  geom_density(aes(performance, fill = cohort), alpha = 0.2, data = exp1) +
  theme_bw() + scale_fill_viridis_d() +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  geom_vline(aes(xintercept = medperf), linetype = 2, data = exp1) +
  geom_vline(aes(xintercept = medperf), linetype = 3, data = summ_Exp1) +
  labs(fill = "cohort") + guides(color = FALSE)

```
  
# Discussion

The effect of the background level of probability on volume in Experiment 3 was only present if the probability of 0.2 was included, otherwise discrimination performance was unaffected by probability.
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Methods and Materials

Guidelines can be included for standard research article sections, such as this one. 

Any "personal communications" relating to unpublished data should be incorporated within the main text, in the following format: (Author Initial(s) and Surname, personal communication, Month and Year). Authors should have permission from anyone named in this way and should be aware that a supporting letter will sometimes be requested.
Within the Materials and Methods and/or figure legends, we encourage authors to provide complete information about their experiments, analyses, or data collection to ensure that readers can easily understand what was measured and analysed, and can accurately perform the relevant protocols.
In cases where a new method within the submission would benefit from step-by-step protocols in addition to the methods described in the article, we would encourage authors to also consider submitting a detailed protocol to Bio-protocol.
On first mention, please provide details of any manufacturers in the following format: company name, city, country (or state, if based in the United States).

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Appendix

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

(ref:labappfig1) **Some text about the Appendix Fig. 1**. More text after that

```{r appfig1, fig.cap="(ref:labappfig1)"}
alpha_14 <- 0.05/5

exp14 <- summaries %>%
  filter(!str_detect(cond, "[r]"), experiment == 1 | experiment == 4) %>%
  mutate(rep = ifelse(experiment == 1, 1, 2)) %>%
  ungroup() %>%
  mutate(rep = factor(rep))

exp14_simpl <- exp14 %>%
  ungroup() %>%
  # mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
  #                                as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort, rep) %>%
  summarise(performance = mean(performance))

# exp14_simpl %>%
#   ggplot(aes(cond, performance)) + geom_point(aes(color = cohort, shape = rep))

exp14_diff <- exp14_simpl %>%
  spread(rep, performance) %>%
  mutate(difference = `1` - `2`)

set.seed(42)
exp14_diff %>%
  # filter(cohort != 2) %>%
  ggplot() +
  geom_hline(yintercept = 0.1, linetype = 2) + geom_hline(yintercept = -0.1, linetype = 2) +
  stat_summary(aes(cond, difference, color = NULL), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2 * alpha_14),
               color = "darkblue", alpha = 0.7, size = 1) +
  theme_bw() + geom_jitter(aes(cond, difference, color = cohort), alpha = 0.7, width = 0.1) +
  scale_color_viridis_d()

```


(ref:labappfig2) **Some text about the Appendix Fig. 2**. More text after that

```{r appfig2, fig.cap="(ref:labappfig2)"}
exp4_simpl <- exp14_simpl %>%
  filter(rep == 2) %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp4_diff <- exp4_simpl %>%
  spread(cond, performance) %>%
  mutate("BP-BV" = BP - BV, "BP-C" = BP - C, "BV-C" = BV - C,
         "BP-I" = BP - 1 + I, "BV-I" = BV - I) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

set.seed(42)
exp4_diff %>%
 filter(cond != "BP-BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()
```

# Acknowledgments
Individuals who have contributed materially to the work, but do not satisfy the authorship criteria should be listed in the acknowledgements section. Authors should seek permission to include any individuals mentioned in the acknowledgements.  

# Competing interests
At this stage we request that the corresponding author provides a statement of financial and non-financial competing interests on behalf of all authors. Examples include paid employment or consultancy, stock ownership, patent applications, personal relationships with relevant individuals, and membership of an advisory board.



# References
