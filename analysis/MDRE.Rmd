---
title: "Multi-dimensional reward evaluation in mice"
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   # - \usepackage{float} \floatplacement{figure}{H}
   - \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{A\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{A\arabic{figure}}}
output:   
  bookdown::pdf_document2:
    number_sections: no
    toc: no
bibliography: MDRE.bib
---
Vladislav Nachev^1,\*,&#8224;,\S^, Marion Rivalan^1,&#8224;,\S^, York Winter^1,\S^

^1^ Humboldt University, Berlin, Germany

**^\*^For correspondence:** vladislav.nachev\@charite.de  
^&#8224;^These authors contributed equally to this work

**Present Address:** ^\S^Dept. of Biology, Humboldt University, Philippstr. 13, 10099 Berlin, Germany

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Abstract

Please provide an abstract of no more than 150 words. Your abstract should explain the main contributions of your article, and should not contain any material that is not included in the main text. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat.

# Introduction

Your introduction goes here! Some examples of commonly used commands and features are listed below, to help you get started.

Here is a citation: [@kacelnik_risky_1998]
An inline citation has no [] around it, like this: @rivalan_principles_2017.

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Results

```{r, include = FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(lubridate)
library(lme4)
library(coin)
library(kableExtra)
library(Hmisc)
# library(BayesFactor)
# library(citr)

miceChoices <- read.csv2(file = "data/ChoicesOutput.csv", header = TRUE, dec = ".", sep = ";",
                            na.strings = "NA") %>%
  mutate(vol = if_else(cohort == 2, vol * 4.8, vol))

miceChoices <- miceChoices %>%
  group_by(IdLabel, day) %>%
  filter(hour(DateTime) < 9 | hour(DateTime) > 15) %>% # due to older program version the initial visits
  # before the starting could not be flagged and therefore could not be removed by CSVreader.R
  # therefore they need to be removed here
  mutate(count = 1:n(), revcount = n():1) %>%
  group_by(rel,IdLabel,day) %>%
  mutate(relcount = 1:n()) %>%
  ungroup()

summaries <- miceChoices %>%
  group_by(cond, IdLabel, experiment, cohort, rint) %>%
  # take all visits after the first 150 visits at the relevant dispensers:
  filter(relcount > 150) %>%
  # in the following lines is an alternative cut-off point, which leads to very similar results
  # take the last 100 visits at any of the dispensers:
  # filter(revcount < 101) %>%
  summarise(performance = mean(prof, na.rm = TRUE), sampling = 1 - mean(rel),
            Ntot = n(), Nrel = sum(rel),successes_perf = sum(prof, na.rm = T),
            successes_sampl =  Ntot - Nrel) %>%
  ungroup() %>%
  mutate(cohort = factor(cohort))

exp3_tab <- miceChoices %>%
  filter(experiment == 3, !str_detect(cond,"[r]")) %>%
  group_by(cohort, cond) %>%
  summarise(vol = max(volm), prob = max(prob)) %>%
  ungroup() %>%
  mutate(volm = vol/max(vol),
         probm = prob/max(prob),
         dim = str_sub(cond, 1, 1),
         bg_level = ifelse(dim == "P", volm, probm),
         cohort = as.factor(cohort)) %>%
  droplevels()

exp1 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 1)
BVP1 <- exp1 %>%
  filter(cond == "BVP1")
exp2 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 2) %>%
  bind_rows(BVP1)
exp3 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 3) %>%
  inner_join(exp3_tab) %>%
  droplevels()
exp4 <- summaries %>% filter(!str_detect(cond, "[r]"), experiment == 4)

sesoi <- 0.1 # smallest effect size of interest
```

General data quality and quantity overview here. Mention visit numbers, exclusions (if any).

(ref:labresoverview) **Overview of discrimination performance of all mice in all experiments.** Experiments 1 through 4 are shown in different panels (1-4). Each symbol is the mean discrimination performance of an individual mouse over two presentations of the same condition (original and reversal). The experimental conditions are described in detail in Table \@ref(tab:conds). Data are shown in different colors for three diffierent cohorts of eight mice each (total *N* = 24). Cohort 2 (green symbols and lines) was tested in a different cage set-up than cohorts 1 and 2 (see Methods for details). 

```{r resoverview, fig.cap="(ref:labresoverview)"}
ggexp12_4 <- summaries %>%
  filter(!str_detect(cond, "[r]"), experiment != 3) %>%
  ggplot(aes(cond, performance, color = cohort, group = IdLabel)) + geom_point() + geom_line() +
  facet_grid(experiment ~ .) + xlab("condition") + ylab("discrimination performance") +
  theme_bw() + scale_color_viridis_d() + guides(color = FALSE) +
  theme(strip.text.y = element_text(angle = 0))

ggexp3 <- exp3 %>%
  ggplot(aes(cond, performance, color = cohort, group = IdLabel)) + geom_point() + geom_line() +
  facet_grid(experiment ~ .) + xlab("condition") +
  scale_y_continuous(name = "", breaks = seq(0, 1, 0.25)) +
  theme_bw() + scale_color_viridis_d() + theme(legend.position = "bottom") +
  theme(strip.text.y = element_text(angle = 0))

get_legend <- function(a.gplot){ 
  tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
  leg <- which(map(tmp$grobs, "name") == "guide-box") 
  legend <- tmp$grobs[[leg]] 
  return(legend)} 

leg <- get_legend(ggexp3)

lay <- rbind(c(1, 3),
             c(1, 2),
             c(1, NA))

grid.arrange(ggexp12_4, ggexp3 + guides(color = FALSE), leg, layout_matrix = lay,
             heights = c(1, 1.3, 1))
```

Compared to the baselines, in experiment 1 mice improved their discrimination performance in the congruent condition and decreased their performance in the incongruent condition (Fig. \@ref(fig:exp1)). 

(ref:labresexp1) **Difference between discrimination performance in the baseline conditions and in the congruent and incongruent conditions in experiment 1**. Symbols show the individual differences in discrimination performance for the given conditions of each individual mouse (*N* = 24). Mice from different cohorts are shown in different colors. Large blue symbols give the means and the blue vertical lines the 90%-confidence intervals from bootstraps, corrected for multiple comparisons. When the confidence intervals lie completely within the smallest effect size of interest (sesoi) interval bounded by the dashed lines, there is statistical support for equivalence. When the confidence intervals do not cross the zero line, there is statistical support for difference. If the confidence intervals cross the zero line, but are not completely bounded by the sesoi, the results are inconclusive. The discrimination performances in the baseline conditions were calculated from the mean values from the two different baseline treatments for each reward dimension (volume and probability), i.e. BP was the mean of BPV1 and BPV2, and BV was the mean of BVP1 and BVP2.

```{r exp1, fig.cap="(ref:labresexp1)"}
exp1_simpl <- exp1 %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp1_diff <- exp1_simpl %>%
  spread(cond, performance) %>%
  mutate("BP - BV" = BP - BV, "C - BP" = C - BP, "C - BV" = C - BV,
         "I - BP" = 1 - I - BP, "I - BV" = I - BV) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

n_compare <- exp1_diff %>%
  ungroup() %>%
  filter(cond != "BP - BV") %>%
  select(cond) %>%
  unique() %>%
  nrow()

alpha_1 <- 0.05
alpha_2 <- 0.05 / (n_compare - 1) # alpha corrected for multiple comparisons

set.seed(42)
exp1_diff %>%
  filter(cond != "BP - BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_2)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()
```


(ref:labresexp2) **Difference between discrimination performance in the baseline conditions and in the congruent and incongruent conditions in experiment 2**. Same notation as in Fig. \@ref(fig:exp1). The discrimination performances in the baseline conditions were calculated from the mean values from the two different baseline treatments for each reward dimension (volume and probability), i.e. BP was the mean of BPV1 and BPV2, and BV was the mean of BVP1 and BVP2, where the values for condition BVP1 were taken from experiment 1. The discrimination performance in the incongruent condition was calculated as the relative preference for the higher probability dispenser when comparing to the probability baseline and for the higher volume dispenser when comparing to the volume baseline.

```{r exp2, fig.cap="(ref:labresexp2)"}
exp2_simpl <- exp2 %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp2_diff <- exp2_simpl %>%
  spread(cond, performance) %>%
  mutate("BP - BV" = BP - BV, "C - BP" = C - BP, "C - BV" = C - BV,
         "I - BP" = 1 - I - BP, "I - BV" = I - BV) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

set.seed(42)
exp2_diff %>%
  filter(cond != "BP - BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()
# 
# exp2_diff %>%
#   group_by(cond) %>%
#   summarise(median = median(difference), lower = , upper = )

```


(ref:labresexp3) **Slope estimates for the effect of the background dimension on the discrimination performance in the relevant dimension**. The two choice options always differed along the relevant dimension (either probability or volume, given on the abscissa) at a fixed relative intensity. The discrimination performance for each mouse was measured at four different levels of the background dimension, which was set at the same values on both choice options, but differed from condition to condition  (Table \@ref(tab:conds)). Each symbol is the average for an individual mouse over the two presentations of the same condition (original and reversal). The smallest effect size of interest was determined to be the slope that would have resulted in a difference in discrimination performance of 0.1, from the lowest to the highest level of the background dimension. The remaining notation is the same as in Fig. \@ref(fig:exp1). The discrimination performance in the incongruent condition was calculated as the relative preference for the higher probability dispenser when comparing to the probability baseline and for the higher volume dispenser when comparing to the volume baseline.

```{r exp3, fig.cap="(ref:labresexp3)"}

slopes <- exp3 %>%
  split(.$dim) %>%
  map(~ lmer(performance ~ bg_level + (bg_level|IdLabel), data = .)) %>%
  map(coef) %>%
  map("IdLabel") %>%
  map_df(~rownames_to_column(., var = "IdLabel"))

dims <- data.frame(dimension = rep(c("prob", "vol"), each = 24))

cohorts <- exp3 %>%
  ungroup() %>%
  select(IdLabel, cohort) %>%
  distinct()

slopes <- slopes %>%
  bind_cols(dims) %>%
  rename(slope = bg_level) %>%
  inner_join(cohorts)

sl_sesoi <- data.frame(val = c(4/20, 20/20),
                       performance = c(0.8, 0.9))

sl_sesoi <- coef(lm(performance ~ val, data = sl_sesoi))[2]

set.seed(42)
slopes %>%
  ggplot(aes(dimension, slope)) +
  stat_summary(fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  geom_hline(yintercept = sl_sesoi, linetype = 2) + geom_hline(yintercept = -sl_sesoi, linetype = 2) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  scale_color_viridis_d()

```

The relative intensities for the two dimensions were the same in cohorts 1,3 (rint = 0.86), but different in cohort 2 (rintp = 0.86, rintv = 0.67).

```{r}

sims_data <- map(list("data/summ_Exp1.csv", "data/summ_Exp2.csv",
                       "data/summ_Exp3.csv", "data/summ_Exp1.csv"),
                     ~ read.csv2(file = ., header = TRUE, dec = ".", sep = ";",
                                na.strings = "NA")) %>%
  map2_df(1:4, ~update_list(.x, experiment = .y)) %>%
  rename(cond = cond_names)
  
summ_sims <- sims_data %>%
  group_by(experiment, Choice_type, cond) %>%
  summarise(medperf = median(performance))

emp_perf <- summaries %>%
  filter(!str_detect(cond, "[r]")) %>%
  select(IdLabel, cohort, experiment, cond, performance)

devs <- summ_sims %>%
  full_join(emp_perf) %>%
  mutate(deviance = (medperf - performance)^2)

rmses <- devs %>%
  group_by(experiment, Choice_type) %>%
  summarise(RMSE = sqrt(mean(deviance, na.rm = TRUE))) %>%
  arrange(experiment, RMSE)

# rmses_inds <- devs %>%
#   group_by(IdLabel, cohort, Choice_type) %>%
#   summarise(RMSE = sqrt(mean(deviance))) %>%
#   filter(!is.na(IdLabel)) %>%
#   mutate(rank = rank(RMSE)) %>%
#   arrange(IdLabel, rank)
# 
# devs %>%
#   group_by(cohort, Choice_type) %>%
#   summarise(RMSE = sqrt(mean(deviance))) %>%
#   filter(!is.na(cohort)) %>%
#   mutate(rank = rank(RMSE)) %>%
#   arrange(cohort, rank)
# rmses_inds  %>%
#   group_by(rank, Choice_type) %>%
#   count() %>%
#   arrange(rank, desc(n))

ranks <- rmses %>%
  mutate(rank = rank(RMSE)) %>%
  ungroup() %>%
  select(-RMSE) %>%
  spread(experiment, Choice_type) 
```

Compared to the empirical data, models 2 and 7 performed best (Table \@ref(tab:simRankTable), see also Appendix 1 Figures \@ref(fig:simexp1), \@ref(fig:simexp2), \@ref(fig:simexp3), and \@ref(fig:simexp4)).

```{r modTable}
data.frame(model = 1:7,
           description = c("product rule", "random dimension",
                           "winner takes it all", "probability first",
                           "volume first", "only volume",
                           "logproduct rule")) %>%
  knitr::kable(booktabs = TRUE, caption = "Decision-making models") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F)
```

```{r simRankTable}
ranks %>%
  knitr::kable(booktabs = TRUE,
               caption = "Best performing models ranked by root-mean-square-deviations (RMSD).") %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F) %>%
  kableExtra::add_header_above(c(" " = 1, "experiment" = 4)) %>%
  kableExtra::footnote(general = "The deviations for the RMSD were calculated from the median of the model to the observed discrimination performances of the experimental mice.", threeparttable = T)
```


# Discussion

The effect of the background level of probability on volume in Experiment 3 was only present if the probability of 0.2 was included, otherwise discrimination performance was unaffected by probability.
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

# Methods and Materials

The different experimental conditions for all animals and cohorts are listed in Table \@ref(tab:conds).

```{r conds}
conds_tab <- miceChoices %>%
  ungroup() %>%
  filter(!str_detect(cond,"[r]"), cohort != 2, between(vol, 1, 20),
         experiment < 4, prob > 0) %>%
  select(experiment, cond, vol, prob) %>%
  distinct() %>%
  arrange(experiment, cond, vol, prob)

conds_tab <- conds_tab %>%
  mutate(odd = row_number(cond) %% 2, vol2 = lead(vol), prob2 = lead(prob)) %>%
  filter(odd == 1) %>%
  select(-odd)

conds_tab %>%
  mutate(cond = if_else(cond == "BVP1",
                       paste0(cond, kableExtra::footnote_marker_alphabet(3)), as.character(cond))) %>%
  knitr::kable(booktabs = TRUE,
               caption = "Overview of the experimental conditions in all four experiments.",
               col.names = c(paste0("experiment", kableExtra::footnote_marker_alphabet(1)),
                             "condition",
                             paste0("volume", kableExtra::footnote_marker_alphabet(2)),
                             "probability",
                             paste0("volume", kableExtra::footnote_marker_alphabet(2)),
                             "probability"), escape = F) %>%
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"),
                full_width = F) %>%
  kableExtra::add_header_above(c(" " = 2, "option A" = 2, "option B" = 2)) %>%
  kableExtra::footnote(alphabet =
                         c("conditions in experiment 1 and 4 were identical; only conditions for experiment 1 are shown here for brevity; ",
                           "the volumes (in microliters) shown are for cohorts 1 and 3. In cohort 2 the volumes were 4.8 instead of 4, 9.6 instead of 10, 14.4 instead of 15, and 20.8 instead of 20 microliters; ",
                           "condition BVP1 in experiment 1 was not repeated in experiment 2, but instead the results from experiment 1 were used in further analyses"), threeparttable = T)
```

Guidelines can be included for standard research article sections, such as this one. 

Any "personal communications" relating to unpublished data should be incorporated within the main text, in the following format: (Author Initial(s) and Surname, personal communication, Month and Year). Authors should have permission from anyone named in this way and should be aware that a supporting letter will sometimes be requested.
Within the Materials and Methods and/or figure legends, we encourage authors to provide complete information about their experiments, analyses, or data collection to ensure that readers can easily understand what was measured and analysed, and can accurately perform the relevant protocols.
In cases where a new method within the submission would benefit from step-by-step protocols in addition to the methods described in the article, we would encourage authors to also consider submitting a detailed protocol to Bio-protocol.
On first mention, please provide details of any manufacturers in the following format: company name, city, country (or state, if based in the United States).

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.

\newpage
# Appendix {-}

\beginsupplement

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras sit amet mauris in ex ultricies elementum vel rutrum dolor. Phasellus tempor convallis dui, in hendrerit mauris placerat scelerisque. Maecenas a accumsan enim, a maximus velit. Pellentesque in risus eget est faucibus convallis nec at nulla. Phasellus nec lacinia justo. Morbi fermentum, orci id varius accumsan, nibh neque porttitor ipsum, consectetur luctus risus arcu ac ex. Aenean a luctus augue. Suspendisse et auctor nisl. Suspendisse cursus ultrices quam non vulputate. Phasellus et pharetra neque, vel feugiat erat. Sed feugiat elit at mauris commodo consequat. Sed congue lectus id mattis hendrerit. Mauris turpis nisl, congue eget velit sed, imperdiet convallis magna. Nam accumsan urna risus, non feugiat odio vehicula eget.


(ref:labappfig1) **Difference in discrimination performance between identical conditions in experiment 1 and experiment 4**. Same notation as in in Fig. \@ref(fig:exp1). The sequence of conditions was pseudo-random in each experiment and different for each individual. Negative differences indicate an increase in discrimination performance with time. Mice were seven weeks old at the beginning of experiment 1 and 13-14 weeks old at the beginning of experiment 4 (a difference of about 7 weeks). The discrimination performance in the incongruent condition was calculated as the relative preference for the higher volume dispenser.    

```{r appfig1, fig.cap="(ref:labappfig1)"}
alpha_14 <- 0.05/5

exp14 <- summaries %>%
  filter(!str_detect(cond, "[r]"), experiment == 1 | experiment == 4) %>%
  mutate(rep = ifelse(experiment == 1, 1, 2)) %>%
  ungroup() %>%
  mutate(rep = factor(rep))

exp14_simpl <- exp14 %>%
  ungroup() %>%
  # mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
  #                                as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort, rep) %>%
  summarise(performance = mean(performance))

# exp14_simpl %>%
#   ggplot(aes(cond, performance)) + geom_point(aes(color = cohort, shape = rep))

exp14_diff <- exp14_simpl %>%
  spread(rep, performance) %>%
  mutate(difference = `1` - `2`)

set.seed(42)
exp14_diff %>%
  ggplot() +
  geom_hline(yintercept = 0.1, linetype = 2) + geom_hline(yintercept = -0.1, linetype = 2) +
  stat_summary(aes(cond, difference, color = NULL), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2 * alpha_14),
               color = "darkblue", alpha = 0.7, size = 1) +
  theme_bw() + geom_jitter(aes(cond, difference, color = cohort), alpha = 0.7, width = 0.1) +
  scale_color_viridis_d()

```


(ref:labappexp4) **Difference between discrimination performance in the baseline conditions and in the congruent and incongruent conditions in experiment 4**. Same notation as in Fig. \@ref(fig:exp1). The discrimination performance in the incongruent condition was calculated as the relative preference for the higher probability dispenser when comparing to the probability baseline and for the higher volume dispenser when comparing to the volume baseline.  

```{r appexp4, fig.cap="(ref:labappexp4)"}
exp4_simpl <- exp14_simpl %>%
  filter(rep == 2) %>%
  ungroup() %>%
  mutate(cond = as.factor(ifelse(str_length(cond) == 4, str_sub(cond, 1, 2),
                                 as.character(cond)))) %>%
  group_by(cond, IdLabel, cohort) %>%
  summarise(performance = mean(performance))

exp4_diff <- exp4_simpl %>%
  spread(cond, performance) %>%
  mutate("BP - BV" = BP - BV, "C - BP" = C - BP, "C - BV" = C - BV,
         "I - BP" = 1 - I - BP, "I - BV" = I - BV) %>%
  select(-BV, -BP, -C, -I) %>%
  gather(cond, difference, -cohort, -IdLabel)

set.seed(42)
exp4_diff %>%
  filter(cond != "BP - BV") %>%
  ggplot(aes(cond, difference)) +
  geom_hline(yintercept = sesoi, linetype = 2) + geom_hline(yintercept = -sesoi, linetype = 2) +
  stat_summary(aes(cond, difference), fun.data = mean_cl_boot,
               fun.args = list(conf.int = 1 - 2*(alpha_1)),
               color = "darkblue", size = 1) +
  theme_bw() + geom_jitter(aes(color = cohort), alpha = 0.7, width = 0.1) +
  xlab("") + scale_color_viridis_d()
```




(ref:labsimexp1) **Comparison of discrimination performances in all seven simulation models and in the three mouse cohorts in Experiment 1**. Columns give the condition names (Table \@ref(tab:conds)) and rows, the model number (Table \@ref(tab:modTable)).  Empirical data from the three cohorts are represented by differently color-filled density curves from the observed discrimination performances. Simulation data are represented by an empty thick-lined density curve. The dashed line gives the median of the empirical data and the dotted line - the median of the simulated data.    

```{r simexp1, fig.height = 7, fig.width = 10, fig.cap="(ref:labsimexp1)"}
exp1 <- exp1 %>%
  group_by(cond) %>%
  mutate(medperf = median(performance))

ggplot() +
  geom_density(aes(performance), size = 1.2, data = sims_data %>% filter(experiment == 1)) +
  facet_grid(Choice_type ~ cond) +
  geom_density(aes(performance, fill = cohort), alpha = 0.2, data = exp1) +
  theme_bw() + scale_fill_viridis_d() +
  scale_x_continuous(name = "discrimination performance", breaks = c(0, 0.5, 1)) +
  geom_vline(aes(xintercept = medperf), linetype = 2, data = exp1) +
  geom_vline(aes(xintercept = medperf), linetype = 3, size = 1.2, data = summ_sims %>%
               filter(experiment == 1)) +
  labs(fill = "cohort") + guides(color = FALSE) + theme(strip.text.y = element_text(angle = 0))

```

(ref:labsimexp2) **Comparison of discrimination performances in all seven simulation models and in the three mouse cohorts in Experiment 2**. Same notation as in Fig. \@ref(fig:simexp1).

```{r simexp2,  fig.height = 7, fig.width = 10, fig.cap="(ref:labsimexp2)"}
exp2 <- exp2 %>%
  group_by(cond) %>%
  mutate(medperf = median(performance))

ggplot() +
  geom_density(aes(performance), size = 1.2, data = sims_data %>% filter(experiment == 2)) +
  facet_grid(Choice_type ~ cond) +
  geom_density(aes(performance, fill = cohort), alpha = 0.2, data = exp2) +
  theme_bw() + scale_fill_viridis_d() +
  scale_x_continuous(name = "discrimination performance", breaks = c(0, 0.5, 1)) +
  geom_vline(aes(xintercept = medperf), linetype = 2, data = exp2) +
  geom_vline(aes(xintercept = medperf), linetype = 3, size = 1.2, data = summ_sims %>%
               filter(experiment == 2)) +
  labs(fill = "cohort") + guides(color = FALSE) + theme(strip.text.y = element_text(angle = 0))

```

(ref:labsimexp3) **Comparison of discrimination performances in all seven simulation models and in the three mouse cohorts in Experiment 3**. Same notation as in Fig. \@ref(fig:simexp1). 

```{r simexp3,  fig.height = 7, fig.width = 10, fig.cap="(ref:labsimexp3)"}
exp3 <- exp3 %>%
  group_by(cond) %>%
  mutate(medperf = median(performance))

ggplot() +
  geom_density(aes(performance), size = 1.2, data = sims_data %>% filter(experiment == 3)) +
  facet_grid(Choice_type ~ cond) +
  geom_density(aes(performance, fill = cohort), alpha = 0.2, data = exp3) +
  theme_bw() + scale_fill_viridis_d() +
  scale_x_continuous(name = "discrimination performance", breaks = c(0, 0.5, 1)) +
  geom_vline(aes(xintercept = medperf), linetype = 2, data = exp3) +
  geom_vline(aes(xintercept = medperf), linetype = 3, size = 1.2, data = summ_sims %>%
               filter(experiment == 3)) +
  labs(fill = "cohort") + guides(color = FALSE) + theme(strip.text.y = element_text(angle = 0))

```

(ref:labsimexp4) **Comparison of discrimination performances in all seven simulation models and in the three mouse cohorts in Experiment 4**. Same notation as in Fig. \@ref(fig:simexp1). 

```{r simexp4,  fig.height = 7, fig.width = 10, fig.cap="(ref:labsimexp4)"}
exp4 <- exp4 %>%
  group_by(cond) %>%
  mutate(medperf = median(performance))

ggplot() +
  geom_density(aes(performance), size = 1.2, data = sims_data %>% filter(experiment == 1)) +
  facet_grid(Choice_type ~ cond) +
  geom_density(aes(performance, fill = cohort), alpha = 0.2, data = exp4) +
  theme_bw() + scale_fill_viridis_d() +
  scale_x_continuous(name = "discrimination performance", breaks = c(0, 0.5, 1)) +
  geom_vline(aes(xintercept = medperf), linetype = 2, data = exp4) +
  geom_vline(aes(xintercept = medperf), linetype = 3, size = 1.2, data = summ_sims %>%
               filter(experiment == 1)) +
  labs(fill = "cohort") + guides(color = FALSE) + theme(strip.text.y = element_text(angle = 0))

```

# Acknowledgments
Individuals who have contributed materially to the work, but do not satisfy the authorship criteria should be listed in the acknowledgements section. Authors should seek permission to include any individuals mentioned in the acknowledgements.  

# Competing interests
At this stage we request that the corresponding author provides a statement of financial and non-financial competing interests on behalf of all authors. Examples include paid employment or consultancy, stock ownership, patent applications, personal relationships with relevant individuals, and membership of an advisory board.



# References
